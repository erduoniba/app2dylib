# app2dylib 使用说明

## 概述

app2dylib 是一个逆向工程工具，用于将 iOS 应用程序的可执行文件转换为动态库 (.dylib)，使其可以在其他应用程序中加载和使用。

## 功能特性

- ✅ 支持现代 iOS 二进制格式 (包括 LC_BUILD_VERSION)
- ✅ 支持多架构文件 (自动使用 lipo 分离)
- ✅ 支持 IPA 文件直接转换
- ✅ 完整的错误处理和进度显示
- ✅ 自动化脚本支持

## 系统要求

- macOS 系统
- Xcode 命令行工具
- Git (用于子模块)

## 构建工具

```bash
# 初始化子模块
git submodule update --init --recursive

# 构建 app2dylib 工具
make restore-symbol

# 清理构建文件
make clean
```

## 使用方法

### 方法一：直接使用 app2dylib 工具

```bash
# 对于单架构文件
./app2dylib input_executable -o output.dylib

# 对于多架构文件，需先分离
lipo input_fat_binary -thin arm64 -output input_arm64
./app2dylib input_arm64 -o output.dylib
```

### 方法二：使用自动化脚本

```bash
# 基本用法
./convert_app_to_dylib_simple.sh input.ipa output.dylib

# 指定架构
./convert_app_to_dylib_simple.sh input.ipa output.dylib arm64e

# 直接转换可执行文件
./convert_app_to_dylib_simple.sh /path/to/executable output.dylib
```

## 完整示例

### 从 IPA 文件转换

```bash
# 1. 从 IPA 转换为 dylib (arm64)
./convert_app_to_dylib_simple.sh MyApp.ipa libMyApp.dylib

# 2. 转换为 arm64e 架构
./convert_app_to_dylib_simple.sh MyApp.ipa libMyApp.dylib arm64e

# 3. 代码签名 (可选)
codesign -f -s - libMyApp.dylib
```

### 从已提取的可执行文件转换

```bash
# 1. 提取 IPA (手动)
unzip MyApp.ipa -d extracted/

# 2. 检查架构
file extracted/Payload/MyApp.app/MyApp

# 3. 如果是多架构，先分离
lipo extracted/Payload/MyApp.app/MyApp -thin arm64 -output MyApp_arm64

# 4. 转换为 dylib
./app2dylib MyApp_arm64 -o libMyApp.dylib
```

## 使用生成的 dylib

转换完成后，可以在其他项目中使用生成的 dylib：

```objc
#import <UIKit/UIKit.h>
#import <dlfcn.h>
#import <mach/mach.h>
#import <mach-o/loader.h>
#import <mach-o/dyld.h>

int main(int argc, char * argv[]) {
    NSString * dylibName = @"libMyApp";
    NSString * path = [[NSBundle mainBundle] pathForResource:dylibName ofType:@"dylib"];
    
    // 加载 dylib
    if (dlopen(path.UTF8String, RTLD_NOW) == NULL){
        NSLog(@"dlopen failed: %s", dlerror());
        return 0;
    }
    
    // 获取 ASLR slide
    uint32_t dylib_count = _dyld_image_count();
    uint64_t slide = 0;
    for (int i = 0; i < dylib_count; i++) {
        const char * name = _dyld_get_image_name(i);
        if ([[NSString stringWithUTF8String:name] isEqualToString:path]) {
            slide = _dyld_get_image_vmaddr_slide(i);
            break;
        }
    }
    
    // 调用 OC 方法
    Class targetClass = NSClassFromString(@"MyClass");
    if (targetClass) {
        id instance = [[targetClass alloc] init];
        NSString *result = [instance performSelector:@selector(myMethod)];
        NSLog(@"Result: %@", result);
    }
    
    // 调用 C 函数 (需要知道函数地址偏移)
    typedef int (*MyFunction)(const char *);
    MyFunction myFunc = (MyFunction)(slide + 0x12345678); // 替换为实际偏移
    int result = myFunc("test");
    
    return 0;
}
```

## 故障排除

### 常见错误

1. **"app2dylib supports armv7 and arm64 archtecture, but not support fat file"**
   - 原因：输入文件包含多个架构
   - 解决：使用 `lipo` 命令先分离单一架构

2. **"Mach-o file must have a Load Command named LC_VERSION_MIN_MACOSX or LC_VERSION_MIN_IPHONEOS"**
   - 原因：使用了未修复的旧版本工具
   - 解决：使用当前修复版本的工具

3. **"Unknown load command: 0x..."**
   - 原因：现代 iOS 二进制包含新的加载命令
   - 状态：这是正常警告，不影响转换

### 调试建议

```bash
# 检查输入文件架构
file input_file
lipo -info input_file

# 检查输出文件
ls -la output.dylib
hexdump -C output.dylib | head -5

# 验证 dylib 格式 (跳过前面的头部数据)
dd if=output.dylib skip=64 bs=1 count=4 2>/dev/null | hexdump -C
```

## 注意事项

1. **代码签名**：生成的 dylib 需要代码签名才能在 iOS 设备上使用
2. **架构兼容性**：确保 dylib 架构与目标应用架构一致
3. **系统版本**：注意 iOS 版本兼容性
4. **逆向工程**：仅用于学习和研究目的，请遵守相关法律法规

## 技术原理

工具主要执行以下转换：

1. **文件类型转换**：MH_EXECUTE → MH_DYLIB
2. **内存布局调整**：修改 PAGEZERO 段大小
3. **地址重定位**：更新所有内存地址
4. **动态库ID**：添加 LC_ID_DYLIB 加载命令
5. **符号表更新**：调整符号地址

## 更新日志

### 最新版本特性

- ✅ 支持现代 iOS 格式 (LC_BUILD_VERSION)
- ✅ 支持 LC_DYLD_CHAINED_FIXUPS 和 LC_DYLD_EXPORTS_TRIE
- ✅ 改进的错误处理和兼容性
- ✅ 自动化脚本支持